# Lab2 Report
---
##练习0 填写已有实验
	使用的是beyond compare工具，很方便的比较和合并了

##练习1 实现firstfit连续物理内存分配算法
在lab2中执行make qemu，结果出现错误提示：
```
kernel panic at kern/mm/default_pmm.c:238:  
    assertion failed: (p0 = alloc_page()) == p2 - 1
```
提示default_pmm.c的第283行出现错误，然后结合list_add函数看default_alloc_pages和default_free_pages函数，发现它的空闲块插入顺序有问题:每次插入都是从free_list的头部插入，事实上，应该保持free_list的顺序，地址小的空闲块应该放在前面，地址大的空闲块应该放在后面，以便firstfit算法的从头快速查找。

设计与实现：  
a. default_init_memmap()函数：初始化空闲页并计算总数即可；  
b. default_alloc_pages()函数：分配空闲页：  

	1）寻找大空闲块，直至找到，设置标志位，并从链表中删除此页
	2）判断该页是否过大，若过大则分割后再使用
	3）计算空闲页个数并返回

c. default_free_pages()函数：释放已使用的页并合并：
	
	1）将该页插入到freelist中的合适位置；  
	2）改变该页的标志位以及头部计数器
	3）如可能则合并两侧空闲块

##练习2 实现寻找虚拟地址对应的表项 
设计思路：

	1）尝试获取页表
	2）若获取失败则新建一个页表并返回其地址
1. 如果ucore执行过程中访问内存，出现了页访问异常，请问硬件要做哪些事情？  
	答：出现页访问异常后，会进入异常处理程序，硬件需要从硬盘中读取相应的页表到内存中去，然后继续访问；在异常处理过程中，硬件需要保存现场，维护堆栈，对相应寄存器进行处理。
##练习3 释放某虚地址所在的页并取消对应二级页表的映射 
设计思路：
	
	1）判断该页被引用的次数；
	2）若仅仅被引用一次，则该页可被释放。否则，只能释放页表入口。
1. 数据结构Page的全局变量(其实是一个数组)的每一项与页表中的页目录项和页表项有无对应关系?如果有,其对应关系是啥?
	答：有对应关系。Page的全局变量pages对应的是每一个页的虚拟地址，而页表项和页目录项都指向一个页，它们保存的是页的物理地址，通过pte2page、pde2page可以将pte、pte中保存的页映射到page中的虚拟地址对应的页。
